name: Helm Deploy Overrides on KIND

permissions:
  contents: read
  pull-requests: write

on:
  push:
  pull_request:

jobs:
  helm-kind:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Set up KIND cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: smurf-test

      - name: Deploy Helm charts with overrides only
        run: |
          set -e

          GREEN='\033[0;32m'
          BLUE='\033[0;34m'
          YELLOW='\033[1;33m'
          RED='\033[0;31m'
          NC='\033[0m'

          for chart in charts/*; do
            if [ -f "$chart/Chart.yaml" ]; then
              chart_name=$(basename "$chart")
              override_file="$chart/config/override-values.yaml"

              echo -e "${BLUE}========================================${NC}"
              echo -e "${GREEN}üöÄ Chart: ${chart_name}${NC}"
              echo -e "${BLUE}========================================${NC}"

              if [ -f "$override_file" ]; then
                echo -e "${YELLOW}‚ñ∂ Deploying with override-values.yaml${NC}"
                helm upgrade --install "$chart_name" "$chart" \
                  -f "$override_file" \
                  --namespace "$chart_name" \
                  --create-namespace

                echo -e "${GREEN}‚úî Deployed ${chart_name}${NC}"
              else
                echo -e "${RED}‚è≠ Skipped (no override-values.yaml)${NC}"
              fi
            fi
          done
