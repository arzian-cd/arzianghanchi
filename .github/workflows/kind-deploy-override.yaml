name: KIND Deploy (Override Values)

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  kind-deploy-override:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Set up KIND cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: test

      - name: Deploy charts (override values)
        run: |
            set -e

            GREEN='\033[0;32m'
            BLUE='\033[0;34m'
            YELLOW='\033[1;33m'
            RED='\033[0;31m'
            NC='\033[0m'

            echo "## ðŸš€ KIND Deploy (Override Values)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            for chart in charts/*; do
            chart_name=$(basename "$chart")
            override="$chart/config/override-values.yaml"

            if [ -f "$chart/Chart.yaml" ] && [ -f "$override" ]; then
                echo "::group::Deploy override - $chart_name"
                echo -e "${BLUE}==================================================${NC}"
                echo -e "${GREEN}ðŸš€ Deploying: ${chart_name}${NC}"
                echo -e "${BLUE}==================================================${NC}"

                # Real deploy
                helm upgrade --install "$chart_name" "$chart" \
                -f "$override" \
                --namespace "$chart_name" \
                --create-namespace

                # Dry-run for summary
                kinds=$(helm upgrade --install "$chart_name" "$chart" \
                -f "$override" \
                --namespace "$chart_name" \
                --create-namespace \
                --dry-run --debug 2>/dev/null | grep "^Kind:" | sort -u || true)

                echo -e "${YELLOW}â–¶ Kubernetes objects rendered${NC}"
                echo "$kinds"

                # Summary
                echo "### ðŸ“¦ ${chart_name}" >> $GITHUB_STEP_SUMMARY
                if [ -n "$kinds" ]; then
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "$kinds" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                else
                echo "_No Kubernetes objects rendered_" >> $GITHUB_STEP_SUMMARY
                fi

                echo "::endgroup::"
            else
                echo "### â­ ${chart_name}" >> $GITHUB_STEP_SUMMARY
                echo "_Skipped (no override-values.yaml)_" >> $GITHUB_STEP_SUMMARY
            fi
            done



